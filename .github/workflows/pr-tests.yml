name: CI Pipeline
on:
  pull_request:
    branches: [ main, dev ]
  push:
    branches: [ main, dev ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
        
    - name: Run tests with Docker Compose
      run: |
        echo "Running tests with Docker Compose..."
        echo "ACT environment: $ACT"
        echo "CI environment: $CI"
        echo "GITHUB_ACTIONS environment: $GITHUB_ACTIONS"
        
        if [ "$ACT" = "true" ]; then
          echo "ðŸš€ Running in ACT environment - using Maven directly to avoid Docker-in-Docker issues"
          # Build the application first
          ./mvnw clean compile
          # Run only unit tests that work without database connectivity in ACT environment
          ./mvnw test -Dtest='BookingControllerTests,QrCodeControllerTests,HomeControllerTests' -B
        else
          echo "ðŸš€ Running in GitHub Actions - using Docker Compose"
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit
        fi
        
    - name: Cleanup test containers
      if: always()
      run: |
        echo "Cleaning up test containers..."
        if [ "$ACT" = "true" ]; then
          echo "ðŸ§¹ ACT cleanup - just cleaning Maven cache"
          ./mvnw clean || true
        else
          echo "ðŸ§¹ GitHub Actions cleanup - cleaning Docker containers"
          docker compose -f docker-compose.test.yml down -v
          docker system prune -f
        fi

  build-production:
    name: Build Production Image
    runs-on: ubuntu-latest
    needs: [test]
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build production Docker image
      run: |
        echo "Building production Docker image..."
        docker build -t eventhub:latest .
        
    - name: Test production image
      run: |
        echo "Testing production image build..."
        docker images eventhub:latest
        
    - name: Cleanup build artifacts
      if: always()
      run: |
        echo "Cleaning up build artifacts..."
        docker system prune -f


  # Summary job that depends on all other jobs
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test, build-production]
    if: always()
    steps:
      - name: Check all results
        run: |
          echo "=== CI Pipeline Results ==="
          echo "Tests: ${{ needs.test.result }}"
          echo "Build: ${{ needs.build-production.result }}"
          
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "Tests failed"
            exit 1
          elif [ "${{ needs.build-production.result }}" != "success" ]; then
            echo "Production build failed"
            exit 1
          else
            echo "All checks passed successfully!"
          fi